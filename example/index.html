<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript">
            $(function() {
            	
                window.WebSocket = window.WebSocket || window.MozWebSocket;
                
                function logToConsole(message)
                {
                	var pre = document.createElement("p");
                	pre.style.wordWrap = "break-word";
                	pre.innerHTML = getSecureTag() + message;
                	$('#consoleLog').appendChild(pre);

                	while (consoleLog.childNodes.length > 50)
                	{
                		$('#consoleLog').removeChild(consoleLog.firstChild);
                	}
                  
                	$('#consoleLog').scrollTop = consoleLog.scrollHeight;
                }
               
                function onConnect(event) {
                    $('h1').css('color', 'green');
                };

                function onError(event) {
                    $('h1').css('color', 'red');
                };
                
                window.onbeforeunload = function() {
                    websocket.onclose = function () {}; // disable onclose handler first
                    websocket.close()
                };
                
                function onClose(event) {
                    $('h1').css('color', 'red');
                };

                function onMessage(message) {
                    console.log(message.data);
                    if(message.data instanceof ArrayBuffer) {
                        var a = new Int32Array(message.data);
                        $('div').prepend($('<p>', { text: a[0].toString() }));
                    } else {
                        $('div').prepend($('<p>', { text: message.data }));
                    }
                };
                
                $('#connectBut').click(function(event) {
                	var uri = $('#uriInput').val();
                	logToConsole('<span> Connecting to: ' + uri + '</span>');
                    var websocket = new WebSocket(uri,
                    	'v1.verse.tul.cz');
					websocket.binaryType = "arraybuffer";
					
					websocket.onopen = function(event) { onConnect(event) };
					websocket.onerror = function(event) { onError(event) };
					websocket.onclose = function(event) { onClose(event) };
					websocket.onmessage = function(message) { onMessage(message) };
                });
                

                $('#sendBut').click(function(event) {
                    event.preventDefault();
                    var val = $('#messageInput').val();
                    var number = Number(val);
                    if(!isNaN(number)) {
                        var buf = new ArrayBuffer(4);
                        var a = new Int32Array(buf);
                        a[0] = number;
                        websocket.send(buf);
                    } else {
                        websocket.send(val);
                    }
                    $('#messageInput').val('');
                });
                
                $('#closeBut').click(function(event) {
                    event.preventDefault();
                    websocket.close();
                });
            });
        </script>
        </head>
    <body>
        <h1>WebSockets test</h1>
        <form>
	        <b>Message:</b>
	        <br/>
            <input id="uriInput" type="text" value="ws://127.0.0.1:23456"/>
            <br/>
            <button id="connectBut">Connect</button>
            <button id="closeBut">Close</button>
            <br/>
        	<b>Username:</b>
        	<br/>
            <input id="username" type="text" value="username"/>
            <br/>
            <b>Password:</b>
            <br/>
            <input id="password" type="text" value="password"/>
        </form>
        <div id="consoleLog"></div>
        <!-- <button id="sendBut">Send</button> -->
        <div></div>
    </body>
</html>
